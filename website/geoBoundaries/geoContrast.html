<!DOCTYPE HTML>
<!--
	Editorial by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>

<head>
	<title>geoBoundaries</title>
	<meta charset="utf-8" />
    <link rel="stylesheet" href="assets/css/ol.css" type="text/css">
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
	<link rel="stylesheet" type="text/css" href="assets/js/slick/slick.css" />
	<link rel="stylesheet" href="assets/css/main.css" />
	<link rel="stylesheet" href="assets/css/BeerSlider.css" />
	

	<style>
		.tooltip {
  position:relative; /* making the .tooltip span a container for the tooltip text */
  border-bottom:1px dashed #000; /* little indicater to indicate it's hoverable */
}
.tooltip:before {
  content: attr(data-text); /* here's the magic */
  position:absolute;
  
  /* vertically center */
  top:-50%;
  transform:translateX(-100%);
  
  /* move to right */
  left:100%;
  margin-left:15px; /* and add a small left margin */
  
  /* basic styles */
  width:200px;
  padding:10px;
  border-radius:10px;
  background:#000;
  color: #fff;
  text-align:center;
  font-size:12px;

  display:none; /* hide by default */
}
.tooltip:hover:before {
  display:block;
}

.map {
        width: 100%;
        height:600px;
        padding:0;
        margin:0;
      }
      .map:-webkit-full-screen {
        height: 100%;
        margin: 0;
        padding:0;
      }
      .map:-ms-fullscreen {
        height: 100%;
      }
      .map:fullscreen {
        height: 100%;
      }
      .sidepanel{
          height:400px;
          width:20%;
          padding:0;
          margin:0;
      }
.toolbox {
padding-left: 2px;
margin-top: 0px;
margin-left: 2px;
height:600px;
}

.box {
	border-left:1px solid rgb(240, 179, 35);
	border-right:1px solid rgb(240, 179, 35);
	border-bottom:1px solid rgb(240, 179, 35);
	border-top: 1px solid rgb(240, 179, 35);
	border-radius:0;
	
}

li.tab{
	top:0px;
	padding-top:0px;
	border-bottom:0;
	border-left: 1px solid rgb(240, 179, 35);
	border-right: 1px solid rgb(240, 179, 35);
	border-top: 1px solid rgb(240, 179, 35);
	border-bottom: 0px;
}

a{
	border-bottom:0;
}

li.tab.active{
	padding-top:0px;
	border-bottom:0;
	border-left: 1px solid rgb(240, 179, 35);
	border-right: 1px solid rgb(240, 179, 35);
	border-top: 1px solid rgb(240, 179, 35);
}

ul li{
	padding-left: 0;
}



#comparison-file-table {
  border-collapse: collapse;
  width: 100%;
}

#comparison-file-table td, #comparison-file-table th {
  max-width: 150px;
  word-wrap: break-word;
  border: 1px solid #ddd;
  padding: 8px;
}

#comparison-file-table tr:nth-child(even){background-color: #f2f2f2;}

#comparison-file-table tr:hover {background-color: #ddd;}

#comparison-file-table th {
  padding-top: 12px;
  padding-bottom: 12px;
  text-align: left;
  background-color: rgb(255,0,0);
  color: white;
}


#gb-file-table {
  border-collapse: collapse;
  width: 100%;
}

#gb-file-table td, #gb-file-table th {
  max-width: 150px;
  word-wrap: break-word;
  border: 1px solid #ddd;
  padding: 8px;
}

#gb-file-table tr:nth-child(even){background-color: #f2f2f2;}

#gb-file-table tr:hover {background-color: #ddd;}

#gb-file-table th {
  padding-top: 12px;
  padding-bottom: 12px;
  text-align: left;
  background-color: #319FD3;
  color: white;
}



.popup {
  display: block;
  position: fixed;
  left: 0;
  top: 0;
  z-index: 9999;
  width: 100%;
  height: 100%;
  background-color: black;
  background-color: rgba(0, 0, 0, 0.4);
  -webkit-transition: 0.5s;
  overflow: auto;
  transition: all 0.3s linear;
}

.popup-content {
  background-color: #fefefe;
  margin: auto;
  margin-top: 5vh;
  padding: 20px;
  border-radius: 4px;
  width: 80vw;
  height: 90vh;
  overflow: auto;
}

.popup-open { overflow: hidden; }

.is-hidden { display: none; }

.is-visually-hidden { opacity: 0; }

.popup-close {
  color: #aaaaaa;
  float: right;
  font-size: 16px;
}

.popup-close:hover, .popup-close:focus {
  color: #000;
  text-decoration: none;
  cursor: pointer;
}

.is-blurred {
  filter: blur(2px);
  -webkit-filter: blur(2px);
}

	</style>
	
	<!-- Scripts -->
	

	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-9276981-3"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag() { dataLayer.push(arguments); }
		gtag('js', new Date());

		gtag('config', 'UA-9276981-3');
	</script>

  
	<!-- Global site tag (gtag.js) - Google Ads: 984002936 -->
<script async src="https://www.googletagmanager.com/gtag/js?id=AW-984002936"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'AW-984002936');
</script>

<!-- Event snippet for Website traffic conversion page -->
<script>
	gtag('event', 'conversion', {'send_to': 'AW-984002936/BycZCJ_8kdMBEPjimtUD'});
  </script>
  
</head>

<body class="is-preload">

	<!-- Wrapper -->
	<div id="wrapper">

		<!-- Main -->
		<div id="main">
			<div class="inner">

				<!-- Header -->
				<header id="header">
					<span class="logo"><a href="index.html"><strong>geoBoundaries</strong></a> by the <a
							href="http://geolab.wm.edu">William & Mary geoLab</a></span>
					<ul class="icons">
						<li><a href="https://twitter.com/wmgeolab?lang=en" class="icon brands fa-twitter"><span
									class="label">Twitter</span></a></li>
						<li><a href="https://www.linkedin.com/company/51598643/"
								class="icon brands fa-linkedin-in"><span class="label">LinkedIn</span></a></li>
					</ul>
				</header>

				<!-- Banner -->
				<section>
					<header class="main">
						<span><h1>Compare, Contribute, and <span 
							data-text="Build Your Own Boundaries" 
							class="tooltip"> BYOB</span></h1></span>
						
					</header>

					<div class="row gtr-200">
						<div class="col-7 col-12-medium">
							<div id="fullscreen" class="fullscreen">
								<div id="map" class="map">
								</div>
							</div>
						</div>
						<div class="col-5 col-12-medium" style="padding:0; ">
							<div id="toolbox" class="toolbox">
								
								<div id="tab-container" class="tab-container">
									<ul class='etabs'>
										<li class='tab'><a href="#compare">Compare & Contribute</a></li>
										<li class='tab'><a href="#BYOB">Build Your Own</a></li>
									</ul>

									<div id="compare" class="box" style="font-size:14pt; height:575px">
										<hr style="border-color:#319FD3; background-color:#319FD3; margin:3px; height:3px">
									
										Compare this geoBoundary:
										
										<div style="display:block;">
											<select id="country-select" style="width:55%;display:inline;font-size:10pt;" onchange="gbCountryChanged()">
												<!--options should get dynamically populated here-->
											</select>
											<select id="admin-level-select" style="width:40%;display:inline;font-size:10pt;" onchange="gbAdminLevelChanged()">
												<!--options should get dynamically populated here-->
											</select>
										</div>
										<select id="license-select" style="width:95%;display:inline;font-size:10pt;" onchange="gbLicenseChanged();">
											<option value="Open" selected>Open (Fully Open Licenses)</option>
											<option value="Humanitarian">Humanitarian (Most Up-To-Date)</option>
											<option value="Authoritative">Authoritative (UN Recognized)</option>
										</select>
										<div id="gb-info-div">
										</div>
										
										<br>
										<br>
										
										<div>
											<hr style="border-color:rgb(255,0,0); background-color:rgb(255,0,0); margin:3px; height:3px">
										
											<span>
											<span style="display:inline-block">To:</span>
											<select id="comparison-boundary-select" style="display:inline-block; width:90%" onchange="comparisonBoundaryChanged()">
												<!--options should get dynamically populated here-->
											</select>
											</span>
											
											<div id="comparison-info-div" style="padding:5px">
											</div>
											
										</div>
										

										
									</div>

									<div id="BYOB" class="box" style="height:575px">
										Coming soon! 
									</div>


								</div>
								
							</div>

						</div>
					
					</div>
					
					<div id="table-comparison" class="row box" style="width:100%; margin:15px 0px">
						<div id="left-table-div" style="width:49%">
							<hr style="border-color:#319FD3; background-color:#319FD3; margin:3px; height:3px">
							<h3>geoBoundaries:</h3>
						</div>
						
						<div id="right-table-div" style="width:48%">
							<hr style="border-color:rgb(255,0,0); background-color:rgb(255,0,0); margin:3px; height:3px">
							<h3>Comparison Boundary:</h3>
						</div>
					</div>
					
					
					<div id="contribute-popup" class="popup is-hidden is-visually-hidden">
					  <!-- popup content -->
					  <div class="popup-content">
						<div style="text-align:right">
							<a id="close-contribute-popup" class="close-popup" onclick="closeContributePopup()">&times;</a>
						</div>
						<h3>Contribute your boundary file:</h3>
						<form>
							<table style="width:97%; margin:10px">
								<tr>
									<td>Source*:</td>
									<td>
										<input name="source" type="text">
									</td>
								</tr>
								<tr>
									<td>License*:</td>
									<td>
										<input name="license" type="text">
									</td>
								</tr>
								<tr>
									<td>Administrative level*:</td>
									<td>
										<input name="admin-level" type="text">
									</td>
								</tr>
								<tr>
									<td>Year of boundaries*:</td>
									<td>
										<input name="year" type="text">
									</td>
								</tr>
								<tr>
									<td>Organization*:</td>
									<td>
										<input name="organization" type="text">
									</td>
								</tr>
								<tr>
									<td>Contact email*:</td>
									<td>
										<input name="email" type="email">
									</td>
								</tr>
								<tr>
									<td>Notes/comment:</td>
									<td>
										<input name="notes" type="text">
									</td>
								</tr>
							</table>
							
							<div style="text-align:right">
								<button type="submit">Submit!</button>
							</div>
							
						</form>
					  </div>
					</div>
				





				</section>


			</div>
		</div>

		<script>

		</script>
		<!-- Sidebar -->
		<div id="sidebar" , class="inactive">
			<div class="inner">
				<!-- Menu -->
				<nav id="menu">
					<header class="major">
						<h2>Menu</h2>
					</header>
					<ul>
						<li><a href="index.html">Home</a></li>
						<li><a href="index.html#getdata">Get Data</a></li>
						<li><a href="api.html">API & Archive</a></li>
						<li><a href="index.html#citation">Citation and Use</a></li>
						<li><a href="https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0231866">Technical
								Paper</a></li>
						<li><a href="issues.html">Caveats & Roadmap</a></li>
						<li>
							<span class="opener">Get Involved</span>
							<ul>
								<li><a href="https://github.com/wmgeolab/geoBoundaries">GitHub Repository</a></li>
								<li><a href="issues.html#contribute">Contribute Boundaries</a></li>
								<li><a href="https://github.com/wmgeolab/geoBoundaries/issues">Report Issues</a></li>
								<li><a href="https://giving.wm.edu/give-now/#allocation=4674">Buy us a Pizza</a></li>
							</ul>
						</li>


					</ul>
				</nav>


				<!-- Section -->
				<section>
					<header class="major">
						<h2>Get in touch</h2>
					</header>
					<p>Want to contribute, identified an error, or otherwise want to chat? Please reach out!</p>
					<ul class="contact">
						<li class="icon solid fa-envelope"><a href="#">team@geoboundaries.org</a></li>
						<li class="icon solid fa-phone">(757) 221-1970</li>
						<li class="icon solid fa-home">geoLab, Applied Science<br />
							540 Landrum Drive<br />
							Williamsburg, VA 23185</li>
					</ul>
				</section>

				<!-- Footer -->
				<footer id="footer">
					<p class="copyright">Design: <a href="https://html5up.net">HTML5 UP</a>. <tiny>With respect to works
							on or made available through download from the this website, we make no representations or
							warranties—express, implied, or statutory—as to the validity, accuracy, completeness, or
							fitness for a particular purpose; nor represent that use of such works would not infringe
							privately owned rights; nor assume any liability resulting from use of such works; and shall
							in no way be liable for any costs, expenses, claims, or demands arising out of use of such
							works.</tiny>
					</p>
				</footer>

			</div>
		</div>



	</div>


	<script src="assets/js/jquery.min.js"></script>
	<script src="assets/js/browser.min.js"></script>
	<script src="assets/js/breakpoints.min.js"></script>
	<script src="assets/js/util.js"></script>
	<script src="assets/js/main.js"></script>
	<script src="assets/js/jquery.easytabs.js" type="text/javascript"></script>
	<script type="text/javascript" src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
	<script src="assets/js/papaparse.min.js"></script>

	<script type="text/javascript">
		$(document).ready(function () { $('#tab-container').easytabs({animate:false}); });
	</script>
	<script src="assets/js/ol.js"></script>
	<script type="text/javascript">
	
		// contribute form popup actions
	
		function openContributePopup() {
			var popup = document.getElementById('contribute-popup');
			popup.className = "popup"; // is-visually-hidden";
			//setTimeout(function() {
			  //container.className = "MainContainer is-blurred";
			  //popup.className = "popup";
			//}, 100);
			//container.parentElement.className = "ModalOpen";
		};
	
		function closeContributePopup() {
			var popup = document.getElementById('contribute-popup');
			popup.className = "popup is-hidden is-visually-hidden";
			//body.className = "";
			//container.className = "MainContainer";
			//container.parentElement.className = "";
		};
		
		// file upload stuff
	
		<!--for details on local file reading, see https://www.html5rocks.com/en/tutorials/file/dndfiles/ -->
		<!--https://web.dev/read-files/ -->
		<!--https://gis.stackexchange.com/questions/138155/allow-client-to-upload-layers-to-openlayers-3 -->
		<!--https://gis.stackexchange.com/questions/368033/how-to-display-shapefiles-on-an-openlayers-web-mapping-application-that-are-prov
		-->
		function handleFileUpload(evt) {
			var files = evt.target.files; 
			
			// get file contents as a base64 encoded url string
			file = files[0];
			fileExtension = file.name.split('.').pop();
			//alert('local file selected: '+file.name+' - '+fileExtension);
			
			if (fileExtension == 'geojson' | fileExtension == 'json') {
				reader = new FileReader();
				reader.onload = function(e) {
					// use reader results to create new source
					var dataURL = reader.result;
					source = new ol.source.Vector({
						url: dataURL,
						format: new ol.format.GeoJSON({}),
						overlaps: false,
					});
					// update the comparisonLayer
					updateComparisonLayerFromGeoJSON(source, zoomToExtent=true);
					// and also populate a table
					source.on('change', function() {
						<!--for details on local file reading, see https://www.html5rocks.com/en/tutorials/file/dndfiles//-->
						var div = document.getElementById('comparison-info-div');
						
						//////////////
						// make sure the source contains polygon types
						var features = source.getFeatures();
						var geotype = features[0].getGeometry().getType();
						if (!(['Polygon','MultiPolygon'].includes( geotype ))) {
							alert('File must contain Polygon or MultiPolygon types, not "'+geotype+'" type');
							return // exit early
						};
						//////////////
						// info div
						// create basic file info
						var info = document.createElement("div");
						info.style = "margin-left:20px; margin-top:15px; font-size:0.7em";
						info.innerHTML = '';
						info.innerHTML += '<b>Features: </b>'+features.length+'<br>';
						info.innerHTML += '<b>File Name: </b>'+file.name+'<br>';
						info.innerHTML += '<b>File Size: </b>'+(file.size/1000000.0).toFixed(1)+' MB<br>';
						info.innerHTML += '<b>Last Modified: </b>'+file.lastModifiedDate.toISOString().substring(0,10);
						info.innerHTML += '<br><br>';
						div.appendChild(info);
						// and upload button
						var uploadbut = document.createElement("button");
						uploadbut.id = "open-contribute-popup";
						uploadbut.style = "font-size:0.7em";
						uploadbut.textContent = "My Boundary is Better!";
						div.appendChild(uploadbut);
						uploadbut.addEventListener('click', openContributePopup);
						////////////////////
						// table div
						// remove old div if exists
						var div = document.getElementById('comparison-file-preview');
						if (div) {
							div.remove();
						};
						// create table div
						var div = document.createElement("div");
						div.id = 'comparison-file-preview';
						div.style = 'max-height:500px; overflow:scroll; margin-top:10px';
						document.getElementById('right-table-div').appendChild(div);
						// create table
						var table = document.createElement("table");
						table.id = 'comparison-file-table';
						table.style = 'margin-left:10px';
						div.appendChild(table);
						// first headers
						for (feature of features) {
							var row = document.createElement("tr");
							// empty header for feature number
							var cell = document.createElement("th");
							cell.style = 'width:20px';
							row.appendChild(cell);
							// field headers
							var props = feature.getProperties();
							for (key in props) {
								if (key == 'geometry') {continue};
								var cell = document.createElement("th");
								cell.innerHTML = key;
								row.appendChild(cell);
							};
							table.appendChild(row);
							break;
						};
						// then rows
						i = 1;
						for (feature of features) {
							var row = document.createElement("tr");
							// feature number
							var cell = document.createElement("td");
							cell.style = 'width:20px';
							cell.innerHTML = i;
							row.appendChild(cell);
							i++;
							// feature properties
							var props = feature.getProperties();
							for (key in props) {
								if (key == 'geometry') {continue};
								var cell = document.createElement("td");
								var val = props[key];
								cell.innerHTML = val;
								row.appendChild(cell);
							};
							table.appendChild(row);
						};
					});
				};
				// read as data url
				reader.readAsDataURL(file);
			};
		};
		
		function initFileUploadComparisonInfo() {
			var div = document.getElementById('comparison-info-div');
			
			// set basic layout
			div.innerHTML = '\
				<span class="fas fa-file" style="padding:0px 3px important! width:auto"> \
				<input class="fas" type="file" id="file-input" accept=".geojson"> \
				</span> \
				\
				<span data-text="Upload a zipped shapefile, geoJSON or topoJSON.  Expects WGS84 (EPSG 4326)." class="tooltip"> \
				(?) \
				</span> \
			';
			
			// bind file input action
			document.getElementById('file-input').addEventListener('change', handleFileUpload, false);
		};
		
		
		// gb display stuff
		
		function updateGbInfo(features) {
			// remove old div if exists
			var div = document.getElementById('gb-file-info');
			if (div) {
				div.remove();
			};
			// info div
			var div = document.createElement("div");
			div.id = 'gb-file-info';
			document.getElementById('gb-info-div').appendChild(div);
			// get gb metadata
			var iso = document.getElementById('country-select').value;
			var level = document.getElementById('admin-level-select').value;
			var license = document.getElementById('license-select').value;
			var metadata = gbMetadata[license];
			// loop metadata table until reach row matching current iso and level
			for (row of metadata) {
				var rowIso = row[2];
				var rowLevel = row[4];
				if (rowIso == iso & rowLevel == level) {
					var gbSource = row[6] + ', ' + row[7];
					var gbSourceUrl = row[11].replace('https//', 'https://'); // fix url typos
					var gbLicense = row[8];
					var gbLicenseUrl = row[10].replace('https//', 'https://'); // fix url typos
					var gbYear = row[3];
					var gbUpdated = row[12];
					var gbDownloadUrl = 'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/sourceData/gb'+license+'/'+iso+'_'+level+'.zip'; // maybe use csv apiUrl once that's fixed? 
					break;
				};
			};
			// populate info
			var info = document.createElement("div");
			info.style = "margin-left:20px; margin-top:15px; font-size:0.7em";
			info.innerHTML = '';
			info.innerHTML += '<div><b style="vertical-align:middle">Actions: </b><a href="'+gbDownloadUrl+'" download><img src="https://icons-for-free.com/iconfiles/png/512/file+download+24px-131985219323992544.png" height="20px" style="vertical-align:middle"></a></div>';
			info.innerHTML += '<b>Features: </b>'+features.length+'<br>';
			info.innerHTML += '<b>Source: </b><a href="'+gbSourceUrl+'" target="_blank">'+gbSource+'</a><br>';
			info.innerHTML += '<b>License: </b><a href="'+gbLicenseUrl+'" target="_blank">'+gbLicense+'</a><br>';
			info.innerHTML += '<b>Year the Boundary Represents: </b>'+gbYear+'<br>';
			info.innerHTML += '<b>Last Update: </b>'+gbUpdated;
			
			div.appendChild(info);
		};
		
		function updateGbTable(features) {
			////////////////////
			// table div
			// remove old div if exists
			var div = document.getElementById('gb-file-preview');
			if (div) {
				div.remove();
			};
			// create table div
			var div = document.createElement("div");
			div.id = 'gb-file-preview';
			div.style = 'max-height:500px; overflow:scroll; margin-top:10px';
			document.getElementById('left-table-div').appendChild(div);
			// create table
			var table = document.createElement("table");
			table.id = 'gb-file-table';
			table.style = 'margin-left:10px';
			div.appendChild(table);
			// first headers
			for (feature of features) {
				var row = document.createElement("tr");
				// empty header for feature number
				var cell = document.createElement("th");
				cell.style = 'width:20px';
				row.appendChild(cell);
				// field headers
				var props = feature.getProperties();
				for (key in props) {
					if (key == 'geometry') {continue};
					var cell = document.createElement("th");
					cell.innerHTML = key;
					row.appendChild(cell);
				};
				table.appendChild(row);
				break;
			};
			// then rows
			i = 1;
			for (feature of features) {
				var row = document.createElement("tr");
				// feature number
				var cell = document.createElement("td");
				cell.style = 'width:20px';
				cell.innerHTML = i;
				row.appendChild(cell);
				i++;
				// feature properties
				var props = feature.getProperties();
				for (key in props) {
					if (key == 'geometry') {continue};
					var cell = document.createElement("td");
					var val = props[key];
					cell.innerHTML = val;
					row.appendChild(cell);
				};
				table.appendChild(row);
			};
		};
		
		
		// gb metadata stuff
		
		var gbMetadata = {};
		
		function updateGbCountryDropdown() {
			// NOTE: requires that gbMetadata has already been populated
			// get country dropdown
			var select = document.getElementById('country-select');
			// clear all existing dropdown options
			select.innerHTML = '';
			// get gb metadata
			var license = document.getElementById('license-select').value;
			var metadata = gbMetadata[license];
			// get list of unique countries
			var countriesSeen = [];
			var countries = [];
			for (var i = 1; i < metadata.length; i++) {
				var row = metadata[i];
				if (row.length <= 1) {
					// ignore empty rows
					i++;
					continue;
				};
				var name = row[1];
				var iso = row[2];
				var country = {'name':name, 'iso':iso};
				if (!(countriesSeen.includes(country.iso))) {
					// only add if hasn't already been added
					countries.push(country);
					countriesSeen.push(country.iso);
				};
			};
			// sort
			countries.sort(function( a,b ){ if (a.name > b.name) {return 1} else {return -1} })
			// add new options from gbMetadata
			for (country of countries) {
				var opt = document.createElement("option");
				opt.value = country.iso;
				opt.textContent = country.name;
				select.appendChild(opt);
			};
		};
		
		function updateGbCountries(license=null) {
			// determine license dynamically from the dropdown if not specified
			if (license == null) {
				license = document.getElementById('license-select').value;
			};
			// fetch metadata from the specified license if doesn't already in gbMetadata
			if (!(license in gbMetadata)) {
				// determine url of metadata csv
				url = 'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/geoBoundaries'+license+'-meta.csv';
				// define error and success
				function error (err, file, inputElem, reason) {
					alert('geoBoundaries metadata csv failed to load: '+url);
				};
				function success (result) {
					// add the downloaded metadata to gbMetadata
					gbMetadata[license] = result['data'];
					// update the dropdown
					updateGbCountryDropdown();
					updateGbAdminLevelDropdown();
					//gbAdminLevelChanged();
					updateGbLayer(zoomToExtent=true);
					updateComparisonBoundaries();
				};
				// parse
				Papa.parse(url,
							{'download':true,
							'complete':success,
							'error':error,
							}
				);
			} else {
				// metadata already exists, just update the dropdown
				updateGbCountryDropdown();
				updateGbAdminLevelDropdown();
				//gbAdminLevelChanged();
				updateGbLayer(zoomToExtent=true);
				updateComparisonBoundaries();
			};
		};
		
		function updateGbAdminLevelDropdown() {
			// NOTE: requires that gbMetadata has already been populated
			// get admin-level dropdown
			var select = document.getElementById('admin-level-select');
			var selectVal = select.value;
			// clear all existing dropdown options
			select.innerHTML = '';
			// get gb metadata
			var license = document.getElementById('license-select').value;
			var metadata = gbMetadata[license];
			// get current country
			var currentIso = document.getElementById('country-select').value;
			// find available admin-levels for country
			var adminLevelsSeen = [];
			var adminLevels = [];
			for (var i = 1; i < metadata.length; i++) {
				var row = metadata[i];
				if (row.length <= 1) {
					// ignore empty rows
					i++;
					continue;
				};
				var iso = row[2];
				var lvl = row[4];
				if (iso == currentIso) {
					if (!(adminLevelsSeen.includes(lvl))) {
						// only add if hasn't already been added
						adminLevels.push(lvl);
						adminLevelsSeen.push(lvl);
					};
				};
			};
			// sort
			adminLevels.sort()
			// add new options from gbMetadata
			for (lvl of adminLevels) {
				var opt = document.createElement("option");
				opt.value = lvl;
				opt.textContent = lvl;
				select.appendChild(opt);
			};
			// keep the select on the same value (if still available)
			if (adminLevels.includes(selectVal)) {
				select.value = selectVal; 
			};
			// force dropdown change
			gbAdminLevelChanged();
		};
		
		
		// comparison display stuff
		
		function clearComparisonInfo() {
			// clear old div contents if exists
			var div = document.getElementById('comparison-info-div');
			div.innerHTML = '';
		};
		
		function updateComparisonInfo(features) {
			//alert('update comparison info');
			// info div
			var div = document.getElementById('comparison-info-div');
			// clear
			div.innerHTML = '';
			// get geoContrast metadata
			var iso = document.getElementById('country-select').value;
			var level = document.getElementById('admin-level-select').value;
			var sourceName = document.getElementById('comparison-boundary-select').value;
			var metadata = geoContrastMetadata;
			// loop metadata table until reach row matching current iso and level
			for (row of metadata) {
				var rowIso = row[2];
				var rowLevel = row[4];
				if (rowIso == iso & rowLevel == level) {
					var comparisonSource = row[6] + ', ' + row[7];
					var comparisonSourceUrl = row[11];
					var comparisonLicense = row[8];
					var comparisonLicenseUrl = row[10];
					var comparisonYear = row[3];
					var comparisonUpdated = row[12];
					var comparisonDownloadUrl = 'https://raw.githubusercontent.com/wmgeolab/geoContrast/main/releaseData/'+sourceName+'/'+iso+'/'+level+'/'+sourceName+'_'+iso+'_'+level+'.topojson'; // should point to zipfile? also maybe use csv apiUrl once that's fixed? 
					break;
				};
			};
			// populate info
			var info = document.createElement("div");
			info.style = "margin-left:20px; margin-top:15px; font-size:0.7em";
			info.innerHTML = '';
			info.innerHTML += '<div><b style="vertical-align:middle">Actions: </b><a href="'+comparisonDownloadUrl+'" download><img src="https://icons-for-free.com/iconfiles/png/512/file+download+24px-131985219323992544.png" height="20px" style="vertical-align:middle"></a></div>';
			info.innerHTML += '<b>Features: </b>'+features.length+'<br>';
			info.innerHTML += '<b>Source: </b><a href="'+comparisonSourceUrl+'" target="_blank">'+comparisonSource+'</a><br>';
			info.innerHTML += '<b>License: </b><a href="'+comparisonLicenseUrl+'" target="_blank">'+comparisonLicense+'</a><br>';
			info.innerHTML += '<b>Year the Boundary Represents: </b>'+comparisonYear+'<br>';
			info.innerHTML += '<b>Last Update: </b>'+comparisonUpdated;
			
			div.appendChild(info);
		};
		
		function clearComparisonTable() {
			// remove old div if exists
			var div = document.getElementById('comparison-file-preview');
			if (div) {
				div.remove();
			};
		};
		
		function updateComparisonTable(features) {
			////////////////////
			// table div
			// remove old div if exists
			var div = document.getElementById('comparison-file-preview');
			if (div) {
				div.remove();
			};
			// create table div
			var div = document.createElement("div");
			div.id = 'comparison-file-preview';
			div.style = 'max-height:500px; overflow:scroll; margin-top:10px';
			document.getElementById('right-table-div').appendChild(div);
			// create table
			var table = document.createElement("table");
			table.id = 'comparison-file-table';
			table.style = 'margin-left:10px';
			div.appendChild(table);
			// first headers
			for (feature of features) {
				var row = document.createElement("tr");
				// empty header for feature number
				var cell = document.createElement("th");
				cell.style = 'width:20px';
				row.appendChild(cell);
				// field headers
				var props = feature.getProperties();
				for (key in props) {
					if (key == 'geometry') {continue};
					var cell = document.createElement("th");
					cell.innerHTML = key;
					row.appendChild(cell);
				};
				table.appendChild(row);
				break;
			};
			// then rows
			i = 1;
			for (feature of features) {
				var row = document.createElement("tr");
				// feature number
				var cell = document.createElement("td");
				cell.style = 'width:20px';
				cell.innerHTML = i;
				row.appendChild(cell);
				i++;
				// feature properties
				var props = feature.getProperties();
				for (key in props) {
					if (key == 'geometry') {continue};
					var cell = document.createElement("td");
					var val = props[key];
					cell.innerHTML = val;
					row.appendChild(cell);
				};
				table.appendChild(row);
			};
		};
		
		
		// comparison metadata stuff
		
		var geoContrastMetadata = null;
		
		function updateComparisonBoundaries() {
			// fetch metadata if doesn't already exist in geoContrastMetadata
			if (geoContrastMetadata == null) {
				// determine url of metadata csv
				url = 'https://raw.githubusercontent.com/wmgeolab/geoContrast/main/releaseData/geoContrast-meta.csv';
				// define error and success
				function error (err, file, inputElem, reason) {
					alert('geoContrast metadata csv failed to load: '+url);
				};
				function success (result) {
					// add the downloaded metadata to gbMetadata
					geoContrastMetadata = result['data'];
					// update the dropdown
					// ???
					updateComparisonBoundaryDropdown();
				};
				// parse
				Papa.parse(url,
							{'download':true,
							'complete':success,
							'error':error,
							}
				);
			} else {
				// metadata already exists, just update the dropdown
				// ???
				updateComparisonBoundaryDropdown();
			};
		};
		
		function updateComparisonBoundaryDropdown() {
			//alert('update comparison boundary dropdown');
			// get admin-level dropdown
			var select = document.getElementById('comparison-boundary-select');
			var selectVal = select.value;
			// clear all existing dropdown options
			select.innerHTML = '';
			// get current country
			var currentIso = document.getElementById('country-select').value;
			var currentLevel = document.getElementById('admin-level-select').value;
			// get geoContrast metadata
			var metadata = geoContrastMetadata;
			// get list of sources that match the specified country and admin-level
			var sources = [];
			for (var i = 1; i < metadata.length; i++) {
				var row = metadata[i];
				if (row.length <= 1) {
					// ignore empty rows
					i++;
					continue;
				};
				var source = row[6];
				var iso = row[2];
				var level = row[4];
				if (iso==currentIso & level==currentLevel) {
					sources.push(source);
				};
			};
			// sort
			sources.sort()
			// first add empty choice
			opt = document.createElement('option');
			opt.value = 'none';
			opt.textContent = '<None>';
			select.appendChild(opt);
			// add new options from geoContrastMetadata
			for (source of sources) {
				var opt = document.createElement("option");
				opt.value = source;
				opt.textContent = 'Dataset: ' + source;
				select.appendChild(opt);
			};
			// finally add custom upload boundary choice
			opt = document.createElement('option');
			opt.value = 'upload';
			opt.textContent = 'Custom: Your Own Boundary';
			select.appendChild(opt);
			// keep the select on the same value (if still available)
			if (sources.includes(selectVal)) {
				select.value = selectVal; 
			};
			// force dropdown change
			comparisonBoundaryChanged();
		};
		
		
		// dropdown change behavior
		
		function gbLicenseChanged() {
			//alert('license changed');
			updateGbCountries();
		};
		
		function gbCountryChanged() {
			// this might run updateGbLayer twice, once on updateGbAdminLevelDropdown() since admin-level dropdown changes triggers updateGbLayers, and once on call to updateGbLayer(zoomToExtent=true)...
			// maybe updateGbAdminLevelDropdown() would be sufficient, but if the admin stays the same maybe it doesn't get triggered...
			//alert('country changed');
			updateGbAdminLevelDropdown();
			updateGbLayer(zoomToExtent=true);
			updateComparisonBoundaries();
		};
		
		function gbAdminLevelChanged() {
			//alert('admin-level changed');
			updateGbLayer(zoomToExtent=true);
			updateComparisonBoundaries();
		};

		function comparisonBoundaryChanged() {
			//alert('comparison-boundary changed');
			// get user-selected params
			iso3 = document.getElementById('country-select').value;
			level = document.getElementById('admin-level-select').value;
			comparison = document.getElementById('comparison-boundary-select').value;
			// check which comparison source was selected
			if (comparison == 'none') {
				// empty choice selection, clear elements
				clearComparisonInfo();
				clearComparisonTable();
				// clear comparison layer
				clearComparisonLayer();
			} else if (comparison == 'upload') {
				// clear previous elements
				clearComparisonInfo();
				clearComparisonTable();
				// setup the file input elements
				initFileUploadComparisonInfo();
				// clear comparison layer
				clearComparisonLayer();
			} else {
				// update comparison layer with external geoContrast topojson
				updateComparisonLayerWithGeoContrast(zoomToExtent=true);
			};
		};
		
		
		// update layer stuff
		
		function updateGbLayer(zoomToExtent=false) {
			// get user-selected params
			iso3 = document.getElementById('country-select').value;
			level = document.getElementById('admin-level-select').value;
			license = document.getElementById('license-select').value;
			// construct data url from params
			url = 'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gb'+license+'/'+iso3+'/'+level+'/geoBoundaries-'+iso3+'-'+level+'.topojson';
			//alert(url);
			// get the source
			var source = new ol.source.Vector({
				url: url,
				format: new ol.format.TopoJSON({}),
				overlaps: false,
			});
			gbLayer.setSource(source);
			// zoom to new source after source has finished loading
			if (zoomToExtent) {
				source.on('change', function() {
					//alert('gb loaded, zoom to bbox: '+source.getExtent());
					// zoom to extent
					map.getView().fit(source.getExtent());
					// zoom out a little
					map.getView().setZoom(map.getView().getZoom()-1);
				});
			};
			// update the table after source has finished loading
			source.on('change', function() {
				//alert('gb loaded, update info');
				var features = source.getFeatures();
				updateGbTable(features);
				updateGbInfo(features);
			});
			// notify if failed to load source
			source.on(['error','featuresloaderror'], function() {
				alert('Failed to load source from '+source.getUrl()+'. Please choose another source.');
			});
		};
		
		function clearComparisonLayer() {
			source = new ol.source.Vector({
				url: null,
				format: new ol.format.TopoJSON({}),
				overlaps: false,
			});
			comparisonLayer.setSource(source);
		};
		
		function updateComparisonLayerWithGeoContrast(zoomToExtent=false) {
			// get selected source
			sourceName = document.getElementById('comparison-boundary-select').value;
			if (sourceName == null) {
				return
			};
			// construct data url from params
			url = 'https://raw.githubusercontent.com/wmgeolab/geoContrast/main/releaseData/'+sourceName+'/'+iso3+'/'+level+'/'+sourceName+'_'+iso3+'_'+level+'.topojson';
			//alert(url);
			// get the source
			var source = new ol.source.Vector({
				url: url,
				format: new ol.format.TopoJSON({}),
				overlaps: false,
			});
			comparisonLayer.setSource(source);
			// update the table after source has finished loading
			if (zoomToExtent) {
				source.on('change', function() {
					//alert('comparison loaded, zoom to bbox: '+source.getExtent());
					// zoom to extent
					map.getView().fit(source.getExtent());
					// zoom out a little
					map.getView().setZoom(map.getView().getZoom()-1);
				});
			};
			// update the table after source has finished loading
			source.on('change', function() {
				//alert('comparison loaded, update info');
				features = source.getFeatures();
				updateComparisonTable(features);
				updateComparisonInfo(features);
			});
			// notify if failed to load source
			source.on(['error','featuresloaderror'], function() {
				alert('Failed to load source from '+source.getUrl()+'. Please choose another source.');
			});
		};
		
		function updateComparisonLayerFromGeoJSON(source, zoomToExtent=false) {
			// set the new source
			comparisonLayer.setSource(source);
			// zoom to new source after source has finished loading
			if (zoomToExtent) {
				source.on('change', function() {
					//alert('new bbox: '+source.getExtent());
					// get combined extent of gb and uploaded file
					extent = ol.extent.createEmpty();
					ol.extent.extend(extent, source.getExtent());
					ol.extent.extend(extent, gbLayer.getSource().getExtent());
					// zoom to extent
					map.getView().fit(extent);
					// zoom out a little
					map.getView().setZoom(map.getView().getZoom()-1);
				});
			};
			// notify if failed to load source
			source.on(['error','featuresloaderror'], function() {
				alert('Failed to load uploaded file.');
			});
		};
		
		// layer definitions
	
		var gbStyle = new ol.style.Style({
			fill: new ol.style.Fill({
				color: 'rgba(255, 255, 255, 0.4)',
			}),
			stroke: new ol.style.Stroke({
				color: 'rgb(49, 127, 211)',
				width: 1,
			}),
		});
		var gbLayer = new ol.layer.Vector({
			style: gbStyle,
		});
		
		var comparisonStyle = new ol.style.Style({
			fill: new ol.style.Fill({
				color: 'rgba(255, 255, 255, 0)', // fully transparent
			}),
			stroke: new ol.style.Stroke({
				color: 'rgb(255, 0, 0)',
				width: 1,
			}),
		});
		var comparisonLayer = new ol.layer.Vector({
			style: comparisonStyle,
		});
		
		// map
	
		var map = new ol.Map({
			target: 'map',
			controls: ol.control.defaults().extend([new ol.control.FullScreen()]),
			layers: [
			new ol.layer.Tile({
				source: new ol.source.XYZ({
					attributions: 'Satellite Imagery <a href="https://www.maptiler.com/copyright/" target="_blank">&copy; MapTiler</a> ',
					url:
					'https://api.maptiler.com/tiles/satellite/{z}/{x}/{y}.jpg?key=' + 'aknzJQRnZg32XVVPrcYH',
					maxZoom: 20,
				})}),
			  gbLayer,
			  comparisonLayer
			],
			view: new ol.View({
			  center: ol.proj.fromLonLat([37.41, 8.82]),
			  zoom: 4
			})
		});
		
		updateGbCountries();
		
		</script>
</body>

</html>